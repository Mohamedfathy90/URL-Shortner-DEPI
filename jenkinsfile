pipeline {
  agent {
    kubernetes {
      yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  serviceAccountName: jenkins
  containers:
  # Kaniko container for building images
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command:
    - /busybox/cat
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
  
  # kubectl container for Kubernetes operations
  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
  
  volumes:
  - name: docker-config
    emptyDir: {}
'''
    }
  }

  environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
    IMAGE_NAME = "mohfathy/url-shortner-depi-app"
    IMAGE_TAG = "${BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/Mohamedfathy90/URL-Shortner-DEPI.git'
      }
    }

    stage('Build & Push Docker Image') {
      steps {
        container('kaniko') {
          sh '''
            # Create Docker config for Kaniko authentication
            echo "{\\"auths\\":{\\"https://index.docker.io/v1/\\":{\\"auth\\":\\"$(echo -n $DOCKERHUB_CREDENTIALS_USR:$DOCKERHUB_CREDENTIALS_PSW | base64)\\"}}}" > /kaniko/.docker/config.json
            
            # Build and push with Kaniko
            /kaniko/executor \
              --dockerfile=Dockerfile \
              --context=dir://${WORKSPACE} \
              --destination=${IMAGE_NAME}:${IMAGE_TAG} \
              --destination=${IMAGE_NAME}:latest \
              --cache=true \
              --cache-ttl=24h
          '''
        }
      }
    }

    stage('Deploy to EKS') {
      steps {
        container('kubectl') {
          sh """
            echo "üöÄ Deploying to EKS cluster..."
            kubectl set image deployment/app-deployment app-container=${IMAGE_NAME}:${IMAGE_TAG} -n app-ns
            kubectl rollout restart deployment/app-deployment -n app-ns
            kubectl rollout status deployment/app-deployment -n app-ns --timeout=5m
          """
        }
      }
    }

    stage('Run Laravel Migrations') {
      steps {
        container('kubectl') {
          sh '''
            echo "‚õè Running Laravel migrations..."
            POD_NAME=$(kubectl get pods -n app-ns -l app=app-pod -o jsonpath="{.items[0].metadata.name}")
            kubectl exec -n app-ns $POD_NAME -- php artisan migrate --force
          '''
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Pipeline completed successfully!"
      echo "üê≥ Image pushed: ${IMAGE_NAME}:${IMAGE_TAG}"
    }
    failure {
      echo "‚ùå Pipeline failed!"
    }
  }
}
